<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Viewer</title>
    <script src="./assets/fabric.min.js"></script>
    <link rel="stylesheet" href="./assets/font-awesome.min.css">
    <style>
        html, body {
            font-family: 'Trebuchet MS', 'Lucida Sans Unicode', 'Lucida Grande', 'Lucida Sans', Arial, sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden;
            width: 100%;
            height: 100%;
            background-color: black;
        }
        canvas {
            border: none;
            width: 100%;
            height: 100%;
            display: block;
        }
        .canvas-container {
            margin: 0 auto;
            padding: 0;
            width: 100vw;
            height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
        }
        .opacity-control {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 1000;
        }
        .opacity-control input {
            width: 40px;
            height: 300px;
            writing-mode: bt-lr;
            -webkit-appearance: slider-vertical;
        }
        .opacity-control label {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>

<div class="canvas-container">
    <canvas id="canvas"></canvas>
</div>

<div class="opacity-control">
    <input type="range" id="opacity" min="0" max="1" step="0.01" value="0" orient="vertical">
</div>

<button id="backButton" class="file-label" style="position: absolute; top: 10px; left: 10px; z-index: 1000;">
    <i class="fas fa-arrow-left file-icon"></i>
    Back
</button>

<script>
    const canvas = new fabric.Canvas('canvas', {
        height: window.innerHeight,
        width: window.innerWidth
    });

    let baseImage = null;
    let overlay = null;

    function resizeCanvas() {
        canvas.setHeight(window.innerHeight);
        canvas.setWidth(window.innerWidth);

        if (baseImage) {
            const scaleFactor = Math.min(canvas.width / baseImage.width, canvas.height / baseImage.height);
            baseImage.scale(scaleFactor);
            baseImage.set({
                left: canvas.width / 2,
                top: canvas.height / 2,
                originX: 'center',
                originY: 'center'
            });
            canvas.setBackgroundImage(baseImage, canvas.renderAll.bind(canvas));
        }

        if (overlay) {
            const scaleFactor = Math.min(canvas.width / overlay.width, canvas.height / overlay.height);
            overlay.scale(scaleFactor);
            overlay.set({
                left: canvas.width / 2,
                top: canvas.height / 2,
                originX: 'center',
                originY: 'center'
            });
            canvas.renderAll();
        }
    }

    function loadImage(dataUrl, callback) {
        fabric.Image.fromURL(dataUrl, (img) => {
            callback(img);
        }, { crossOrigin: 'anonymous' }); // Ensure cross-origin compatibility
    }

    document.getElementById('opacity').addEventListener('input', (e) => {
        if (overlay) {
            overlay.set('opacity', 1 - parseFloat(e.target.value));
            canvas.renderAll();
        }
    });

    document.getElementById('backButton').addEventListener('click', () => {
        window.history.back();
    });

    window.addEventListener('resize', resizeCanvas);

    document.addEventListener('DOMContentLoaded', async () => {
        const db = await openDatabase();
        const selectedGroup = localStorage.getItem('selectedGroup');

        if (selectedGroup) {
            const group = await getImageGroup(db, selectedGroup);

            if (group) {
                loadImage(group.base, (img) => {
                    baseImage = img;
                    resizeCanvas();
                });

                loadImage(group.overlay, (img) => {
                    overlay = img;
                    overlay.set({
                        selectable: false,
                        evented: false,
                        erasable: true
                    });
                    canvas.add(overlay);
                    resizeCanvas();
                });
            } else {
                console.error('No group data found in IndexedDB for the selected group.');
            }
        } else {
            console.error('No selected group found in localStorage.');
        }
    });

    async function openDatabase() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open('ImageDatabase', 1);

            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains('imageGroups')) {
                    db.createObjectStore('imageGroups', { keyPath: 'groupName' });
                }
            };

            request.onsuccess = (event) => {
                resolve(event.target.result);
            };

            request.onerror = (event) => {
                reject(event.target.error);
            };
        });
    }

    async function getImageGroup(db, groupName) {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction('imageGroups', 'readonly');
            const store = transaction.objectStore('imageGroups');
            const request = store.get(groupName);

            request.onsuccess = (event) => {
                resolve(event.target.result);
            };

            request.onerror = (event) => reject(event.target.error);
        });
    }
</script>
</body>
</html>